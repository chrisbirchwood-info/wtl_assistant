            {/* Notes section */}
            {user?.role === 'teacher' && showNotesSection && (
              <div className="mt-6 border-t pt-4">
                <div className="mb-4 flex items-center justify-between">
                  <h2 className="text-sm font-semibold text-gray-700">Notatki</h2>
                  <button
                    type="button"
                    onClick={() => setNotesCollapsed(v => !v)}
                    className="inline-flex items-center gap-2 text-xs text-gray-600 hover:text-gray-800"
                    aria-expanded={!notesCollapsed}
                  >
                    {notesCollapsed ? 'Rozwiń' : 'Zwiń'}
                  </button>
                </div>
                {!notesCollapsed && (
                  <div className="space-y-4">
                    {noteComposerOpen && (
                      <ThreadNoteComposer
                        threadId={threadId}
                        user={user || undefined}
                        onSaved={() => { setNoteComposerOpen(false); setNotesRefresh(v => v + 1) }}
                        onCancel={() => setNoteComposerOpen(false)}
                      />
                    )}
                    <ThreadNotesSection
                      threadId={threadId}
                      user={user || undefined}
                      defaultOpen={false}
                      hideComposerControls
                      externalRefreshTrigger={notesRefresh}
                    />
                  </div>
                )}
              </div>
            )}

            {/* Survey connections section - hidden until requested unless existing connections present */}
